name: Build & Deploy Crypto

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Build Docker image
      - name: Build Docker image
        run: |
          docker build -t registry.hamdocker.ir/mojtabashahin8/crypto-exchange:latest .

      # Login to Docker registry
      - name: Login to Docker registry
        uses: docker/login-action@v2
        with:
          registry: registry.hamdocker.ir
          username: ${{ secrets.HAMDOCKER_USERNAME }}
          password: ${{ secrets.HAMDOCKER_PASSWORD }}

      # Push image
      - name: Push Docker image
        run: docker push registry.hamdocker.ir/mojtabashahin8/crypto-exchange:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Setup kubectl
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.31.2/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      # Decode kubeconfig
      - name: Set kubeconfig
        run: |
          echo "${{ secrets.KIND_KUBECONFIG_BASE64 }}" | base64 --decode > $HOME/.kube/config

      # Deploy using OneChart
      - name: Deploy with helm / OneChart
        run: |
          helm upgrade --install crypto ./onechart \
            --values ./values.yaml \
            --set image.repository=registry.hamdocker.ir/mojtabashahin8/crypto-exchange \
            --set image.tag=latest
